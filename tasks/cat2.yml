# Not automated
#- name: "MEDIUM | V-38439 | The system must provide automated support for account management functions."

- name: "MEDIUM | V-38443 | PATCH | The /etc/gshadow file must be owned by root."
  file:
      path: /etc/gshadow
      owner: root
  tags:
      - cat2
      - medium
      - V-38443
      - patch
      - file_perms

- block:
    - name: "MEDIUM | V-38444 | AUDIT | iptables module is not idempotent for Policy actions currently"
      shell: ip6tables -S | grep '\-P INPUT' | cut -d ' ' -f 3
      changed_when: no
      failed_when: no
      check_mode: no
      register: ip6tables_input_chain_policy_check

    - name: "MEDIUM | V-38444 | PATCH | The systems local IPv6 firewall must implement a deny-all, allow-by-exception policy for inbound packets."
      iptables:
          chain: INPUT
          ip_version: ipv6
          policy: DROP
      when: "ip6tables_input_chain_policy_check.stdout != 'DROP'"
      notify: save ip6tables rules
  when:
      - rhel6stig_ipv6_required
  tags:
      - cat2
      - medium
      - V-38444
      - ipv6
      - firewall
      - network
      - patch

- block:
    - name: "PRELIM | Get path of auditd log file"
      shell: "grep '^log_file' /etc/audit/auditd.conf | sed s/^[^\\/]*//"
      changed_when: no
      check_mode: no
      register: auditd_logfile

    - name: "MEDIUM | V-38445 | PATCH | Audit log files must be group-owned by root."
      file:
          path: "{{ auditd_logfile.stdout }}"
          group: root
  tags:
      - cat2
      - medium
      - V-38445
      - log_files
      - auditd
      - patch

- name: "MEDIUM | V-38446 | PATCH | The mail system must forward all mail for root to one or more system administrators."
  lineinfile:
      dest: /etc/aliases
      line: 'root: {{ rhel6stig_root_email_address }}'
      state: present
  tags:
      - cat2
      - medium
      - V-38446
      - sendmail

- name: "MEDIUM | V-38448 | PATCH | The /etc/gshadow file must be group-owned by root."
  file:
      path: /etc/gshadow
      group: root
  tags:
    - cat2
    - medium
    - V-38448
    - patch
    - file_perms

- name: "MEDIUM | V-38449 | PATCH | The /etc/gshadow file must have mode 0000"
  file:
      path: /etc/gshadow
      mode: "0000"
  tags:
    - cat2
    - medium
    - V-38449
    - patch
    - file_perms

- name: "MEDIUM | V-38450 | PATCH | The /etc/passwd file be owned by root"
  file:
      path: /etc/passwd
      owner: root
  tags:
    - cat2
    - medium
    - V-38450
    - patch
    - file_perms

- name: "MEDIUM | V-38451 | PATCH | The /etc/passwd file be group-owned by root"
  file:
      path: /etc/passwd
      group: root
  tags:
    - cat2
    - medium
    - V-38451
    - patch
    - file_perms

- name: "MEDIUM | V-38457 | PATCH | The /etc/passwd file must have mode 0644 or less permissive"
  file:
      path: /etc/passwd
      mode: "u-x,g-wx,o-wx"
  tags:
    - cat2
    - medium
    - V-38457
    - patch
    - file_perms

- name: "MEDIUM | V-38458 | PATCH | The /etc/group file be owned by root"
  file:
      path: /etc/group
      owner: root
  tags:
    - cat2
    - medium
    - V-38458
    - patch
    - file_perms

- name: "MEDIUM | V-38459 | PATCH | The /etc/group file be group-owned by root"
  file:
      path: /etc/group
      group: root
  tags:
    - cat2
    - medium
    - V-38459
    - patch
    - file_perms

- name: "MEDIUM | V-38461 | PATCH | The /etc/group file must have mode 0644 or less permissive"
  file:
      path: /etc/group
      mode: "u-x,g-wx,o-wx"
  tags:
      - cat2
      - medium
      - V-38461
      - patch
      - file_perms

- name: "MEDIUM | V-38464 | PATCH | The audit system must take appropriate action when there are disk errors on the audit storage volume."
  lineinfile:
      regexp: '(^disk_error_action\s*=)(\s*)'
      line: '\1 {{ rhel6stig_auditd_config["disk_full_action"] }}'
      dest: /etc/audit/auditd.conf
      backrefs: yes
  tags:
      - cat2
      - medium
      - V-38464
      - patch
      - auditd

- block:
    - name: "MEDIUM | V-38465 | AUDIT | Library files must have mode 0755 or less permissive"
      shell: find -L /{lib,lib64,usr/{lib,lib64}/,usr/local/{lib,lib64}}/ -type f -links -2 -perm /022 -exec readlink -f {} \;
      check_mode: no
      changed_when: no
      failed_when: no
      register: sys_lib_perms_audit

    - name: "MEDIUM | V-38465 | PATCH | Library files must have mode 0755 or less permissive"
      file:
          state: file
          mode: "go-w"
          path: "{{ item }}"
      when: sys_lib_perms_audit.stdout
      with_items: "{{ sys_lib_perms_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38465
      - patch
      - file_perms

- block:
    - name: "MEDIUM | V-38466 | AUDIT | Library files must be owned by root"
      shell: find -L /{lib,lib64,usr/{lib,lib64}/,usr/local/{lib,lib64}}/ -type f -links -2 \! -user root -exec readlink -f {} \;
      check_mode: no
      changed_when: no
      failed_when: no
      register: sys_lib_owner_audit

    - name: "MEDIUM | V-38466 | PATCH | Library files must be owned by root"
      file:
          state: file
          owner: "root"
          path: "{{ item }}"
      when: sys_lib_owner_audit.stdout
      with_items: "{{ sys_lib_owner_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38466
      - patch
      - file_perms

- name: "MEDIUM | V-38468 | PATCH | The audit system must take appropriate action when the audit storage volume is full."
  lineinfile:
      regexp: '(^disk_full_action\s*=)(\s*)'
      line: '\1 {{ rhel6stig_auditd_config["disk_full_action"] }}'
      dest: /etc/audit/auditd.conf
      backrefs: yes
  tags:
      - cat2
      - medium
      - V-38468
      - patch
      - auditd

- block:
    - name: "MEDIUM | V-38469 | AUDIT | All system command files must have mode 755 or less permissive."
      shell: find -L /{sbin,bin,usr/{sbin,bin}/,usr/local/{sbin,bin}}/ -type f -links -2 -perm /022 -exec readlink -f {} \;
      check_mode: no
      changed_when: no
      failed_when: no
      register: sys_command_perms_audit

    - name: "MEDIUM | V-38469 | PATCH | All system command files must have mode 755 or less permissive"
      file:
          state: file
          mode: "og-w"
          path: "{{ item }}"
      when: sys_command_perms_audit.stdout
      with_items: "{{ sys_command_perms_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38469
      - patch
      - file_perms

- name: "MEDIUM | V-38470 | PATCH | The audit system must alert designated staff members when the audit storage volume approaches capacity."
  lineinfile:
      regexp: '(^space_left_action\s*=)(\s*)'
      line: '\1 {{ rhel6stig_auditd_config["space_left_action"] }}'
      dest: /etc/audit/auditd.conf
      backrefs: yes
  tags:
      - cat2
      - medium
      - V-38470
      - patch
      - auditd

- block:
    - name: "MEDIUM | V-38472 | AUDIT | All system command files must be owned by root"
      shell: find -L /{sbin,bin,usr/{sbin,bin}/,usr/local/{sbin,bin}}/ -type f -links -2 \! -user root -exec readlink -f {} \;
      check_mode: no
      changed_when: no
      failed_when: no
      register: sys_command_owner_audit

    - name: "MEDIUM | V-38472 | PATCH | All system command files must be owned by root"
      file:
          state: file
          path: "{{item}}"
          owner: root
      when: sys_command_owner_audit.stdout
      with_items: "{{ sys_command_owner_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38472
      - patch
      - file_perms

- name: "MEDIUM | V-38475 | PATCH | The system must require passwords to contain a minimum of 14 characters."
  lineinfile:
      regexp: '(^PASS_MIN_LEN)\s*(\d*)'
      line: '\1 {{ rhel6stig_pass_min_length }}'
      dest: /etc/login.defs
      backrefs: yes
  tags:
      - cat2
      - medium
      - V-38475
      - patch
      - passwords

- name: "MEDIUM | V-38477 | PATCH | Users must not be able to change passwords more than once every 24 hours."
  lineinfile:
      regexp: '(^PASS_MIN_DAYS)\s*(\d*)'
      line: '\1 {{ rhel6stig_pass_min_days }}'
      dest: /etc/login.defs
      backrefs: yes
  tags:
      - cat2
      - medium
      - V-38477
      - patch
      - passwords

- name: "MEDIUM | V-38479 | PATCH | User passwords must be changed at least every 60 days."
  lineinfile:
      regexp: '(^PASS_MAX_DAYS)\s*(\d*)'
      line: '\1 {{ rhel6stig_pass_max_days }}'
      dest: /etc/login.defs
      backrefs: yes
  tags:
      - cat2
      - medium
      - V-38479
      - patch
      - passwords

- name: "MEDIUM | V-38481 | PATCH | System security patches and updates must be installed and up-to-date."
  yum:
      name: '*'
      state: latest
      update_cache: yes
  when: rhel6stig_update_all_packages
  tags:
      - cat2
      - medium
      - V-38481
      - patch
      - yum
      - updates

- block:
    - name: "MEDIUM | V-38483 | AUDIT | The system package management tool must cryptographically verify the authenticity of system software packages during installation."
      shell: find /etc/yum{.conf,.repos.d/} -exec grep -ls '^gpgcheck=0' {} \;
      changed_when: false
      check_mode: no
      register: repo_crypto_check_audit

    - name: "MEDIUM | V-38483 | PATCH | The system package management tool must cryptographically verify the authenticity of system software packages during installation."
      replace:
          backup: yes
          dest: '{{ item }}'
          regexp: '^gpgcheck=0'
          replace: 'gpgcheck=1'
      with_flattened:
        - /etc/yum.conf
        - "{{ repo_crypto_check_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38483
      - patch
      - rpm
      - gpgcheck

- name: "MEDIUM | V-38484 | PATCH | The operating system, upon successful logon, must display to the user the date and time of the last logon or access via ssh."
  lineinfile:
      state: present
      dest: /etc/ssh/sshd_config
      regexp: '^#?PrintLastLog'
      line: PrintLastLog yes
      validate: sshd -t -f %s
  tags:
      - cat2
      - medium
      - patch
      - V-38484
      - sshd

# Not automated
#- name: "MEDIUM | V-38486 | The operating system must conduct backups of system-level information contained in the information system per organization defined frequency to conduct backups that are consistent with recovery time and recovery point objectives."

# Not automated
#- name: "MEDIUM | V-38488 | The operating system must conduct backups of user-level information contained in the operating system per organization defined frequency to conduct backups consistent with recovery time and recovery point objectives."

- name: "MEDIUM | V-38489 | PATCH | A file integrity tool must be installed."
  yum:
      name: aide
      state: present
  notify: init aide
  tags:
      - cat2
      - medium
      - V-38489
      - patch
      - aide
      - integrity

- name: "MEDIUM | V-38490 | PATCH | The operating system must enforce requirements for the connection of mobile devices to operating systems."
  copy:
      content: install usb-storage /bin/true
      dest: /etc/modprobe.d/disable-usb.conf
      owner: root
      group: root
      mode: "0644"
  tags:
      - cat2
      - medium
      - V-38490
      - mobile_devices
      - usb_devices
      - kernel_modules
      - patch

- name: "MEDIUM | V-38492 | PATCH | The system must prevent the root account from logging in from virtual consoles"
  lineinfile:
      state: absent
      dest: /etc/securetty
      regexp: '^.*vc/?\d'
      backup: yes
  tags:
      - cat2
      - medium
      - V-38492
      - root_access
      - logon_settings
      - tty
      - virtual_consoles
      - medium
      - patch

- block:
    - name: "MEDIUM | V-38493 | AUDIT | Audit log directories must have mode 0755 or less permissive."
      shell: grep "^log_file" /etc/audit/auditd.conf|sed 's/^[^/]*//; s/[^/]*$//' | xargs -I % find % -type d -perm /022
      changed_when: no
      check_mode: no
      failed_when: no
      register: audit_log_dir_perms_audit

    - name: "MEDIUM | V-38493 | PATCH | Audit log directories must have mode 0755 or less permissive."
      file:
          state: directory
          mode: "go-w"
          path: "{{ item }}"
      with_items: "{{ audit_log_dir_perms_audit.stdout_lines }}"
      when: audit_log_dir_perms_audit.stdout
  tags:
      - cat2
      - medium
      - V-38493
      - patch
      - file_perms
      - auditd
      - audit_permissions

- block:
    - name: "MEDIUM | V-38495 | AUDIT | Audit log files must be owned by root."
      shell: grep "^log_file" /etc/audit/auditd.conf|sed 's/^[^/]*//; s/[^/]*$//' | xargs -I % find % -type f ! -user root
      changed_when: no
      check_mode: no
      failed_when: no
      register: audit_log_dir_owner_audit

    - name: "MEDIUM | V-38495 | PATCH | Audit log files must be owned by root."
      file:
          state: file
          owner: root
          path: "{{ item }}"
      with_items: "{{ audit_log_dir_owner_audit.stdout_lines }}"
      when: audit_log_dir_owner_audit.stdout
  tags:
      - cat2
      - medium
      - V-38495
      - patch
      - file_perms
      - auditd
      - audit_permissions

- block:
    - name: "MEDIUM | V-38496 | AUDIT | Default system accounts, other than root, must be locked"
      shell: >
       awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ {print $1}' /etc/shadow | xargs -I{} grep {} /etc/passwd | awk -F: '$3 < 500 {print $1}'
      changed_when: no
      failed_when: no
      check_mode: no
      register: unlocked_sys_accounts_audit

    - name: "MEDIUM | V-38496 | PATCH | Default system accounts, other than root, must be locked"
      user:
          name: "{{ item }}"
          state: present
          expires: 1412541480
      with_items: "{{ unlocked_sys_accounts_audit.stdout_lines }}"
      when: unlocked_sys_accounts_audit.stdout
  tags:
      - cat2
      - medium
      - V-38496
      - patch
      - accounts
      - system_accounts

- block:
    - name: "MEDIUM | V-38498 | AUDIT | Audit log files must have mode 0640 or less permissive."
      shell: grep "^log_file" /etc/audit/auditd.conf|sed s/^[^\/]*//|xargs stat -c %n | xargs -I % find % -perm /137
      changed_when: no
      failed_when: no
      check_mode: no
      register: audit_log_file_perms_audit

    - name: "MEDIUM | V-38498 | PATCH | Audit log files must have mode 0640 or less permissive."
      file:
          state: file
          path: "{{ item }}"
          mode: "u-x,g-wx,o-rwx"
      with_items: "{{ audit_log_file_perms_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38498
      - patch
      - auditd
      - logs
      - V-38498
      - file_perms

# Not automated
# - name: "MEDIUM | V-38499 | AUDIT | The /etc/passwd file must not contain password hashes"

# Not automated
# - name: "MEDIUM | V-38500 | AUDIT | The root account must be the only account having a UID of 0"

- name: "MEDIUM | V-38501 | PATCH | The system must disable accounts after excessive login failures within a 15-minute interval."
  pamd:
      name: "{{ item }}"
      new_type: auth
      new_control: required
      new_module_path: pam_faillock.so
      module_arguments: preauth silent deny=3 unlock_time=604800 fail_interval=900
      state: before
      type: auth
      control: sufficient
      module_path: pam_unix.so
  with_items:
      - password-auth
      - system-auth
  tags:
      - medium
      - cat2
      - logon_settings
      - patch
      - V-38501
      - pam

- name: "MEDIUM | V-38501 | PATCH | The system must disable accounts after excessive login failures within a 15-minute interval."
  pamd:
      name: "{{ item }}"
      new_type: auth
      new_control: '[default=die]'
      new_module_path: pam_faillock.so
      module_arguments: authfail deny=3 unlock_time=604800 fail_interval=900
      state: after
      type: auth
      control: sufficient
      module_path: pam_unix.so
  with_items:
      - password-auth
      - system-auth
  tags:
      - medium
      - cat2
      - logon_settings
      - patch
      - V-38501
      - pam

- name: "MEDIUM | V-38501 | PATCH | The system must disable accounts after excessive login failures within a 15-minute interval."
  pamd:
      name: "{{ item }}"
      new_type: account
      new_control: required
      new_module_path: pam_faillock.so
      state: before
      type: account
      control: required
      module_path: pam_unix.so
  with_items:
      - password-auth
      - system-auth
  tags:
      - medium
      - cat2
      - logon_settings
      - patch
      - V-38501
      - pam

- name: "MEDIUM | V-38502 | PATCH | The /etc/shadow file must be owned by root."
  file:
      state: file
      owner: root
      path: /etc/shadow
  tags:
      - cat2
      - medium
      - cat2
      - V-38502
      - shadow
      - file_perms
      - patch

- name: "MEDIUM | V-38503 | PATCH | The /etc/shadow file must be group-owned by root."
  file:
      state: file
      group: root
      path: /etc/shadow
  tags:
      - cat2
      - medium
      - V-38503
      - shadow
      - file_perms
      - patch

- name: "MEDIUM | V-38504 | PATCH | The /etc/shadow file must have mode 0000."
  file:
      state: file
      mode: "0000"
      path: /etc/shadow
  tags:
      - cat2
      - medium
      - V-38504
      - shadow
      - file_perms
      - patch

- name: "MEDIUM | V-38511 | PATCH | IP forwarding for IPv4 must not be enabled unless the system is a router"
  sysctl:
      name: net.ipv4.ip_forward
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  when: not rhel6stig_system_is_router
  tags:
      - cat2
      - V-38511
      - kernel_parameters
      - network
      - medium
      - patch

- name: |
        MEDIUM | V-38512 | PATCH | The operating system must prevent public IPv4 access into an organizations internal networks except as appropriately mediated by managed interfaces employing boundary protection devices
        MEDIUM | V-38555 | PATCH | The system must employ a local IPv4 firewall.
        MEDIUM | V-38560 | PATCH | The operating system must connect to external networks or information systems only through managed IPv4 interfaces consisting of boundary protection devices arranged in accordance with an organizational security architecture.
  service:
      name: iptables
      enabled: yes
      state: started
  tags:
      - V-38512
      - V-38555
      - V-38560
      - ipv4
      - network
      - firewall
      - medium
      - cat2
      - patch

- block:
    - name: "MEDIUM | V-38513 | AUDIT | iptables module is not idempotent for Policy actions currently"
      shell: iptables -S | grep '\-P INPUT' | cut -d ' ' -f 3
      changed_when: no
      failed_when: no
      check_mode: no
      register: iptables_input_chain_policy_check

    - name: "MEDIUM | V-38513 | PATCH | The systems local IPv4 firewall must implement a deny-all, allow-by-exception policy for inbound packets."
      iptables:
          chain: INPUT
          ip_version: ipv4
          policy: DROP
      when: "iptables_input_chain_policy_check.stdout != 'DROP'"
      notify: save iptables rules
  tags:
      - cat2
      - medium
      - V-38513
      - ipv4
      - firewall
      - network
      - patch

- name: "MEDIUM | V-38514 | PATCH | The Datagram Congestion Control Protocol (DCCP) must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install dccp /bin/true
      dest: /etc/modprobe.d/disable-dccp.conf
      owner: root
      group: root
      mode: "0644"
  tags:
      - V-38514
      - cat2
      - medium
      - dccp
      - transport
      - patch

- name: "MEDIUM | V-38515 | PATCH | The Stream Control Transmission Protocol (SCTP) must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install sctp /bin/true
      dest: /etc/modprobe.d/disable-sctp.conf
      owner: root
      group: root
      mode: "0644"
  tags:
      - V-38515
      - cat2
      - medium
      - sctp
      - transport
      - patch

- name: "MEDIUM | V-38516 | PATCH | The Transparent Inter-Process Communication (TIPC) protocol must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install tipc /bin/true
      dest: /etc/modprobe.d/disable-tipc.conf
      owner: root
      group: root
      mode: "0644"
  tags:
      - V-38516
      - cat2
      - medium
      - tipc
      - transport
      - patch

- name: "MEDIUM | V-38517 | PATCH | The Transparent Inter-Process Communication (TIPC) protocol must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install tipc /bin/true
      dest: /etc/modprobe.d/disable-tipc.conf
      owner: root
      group: root
      mode: "0644"
  tags:
      - cat2
      - medium
      - V-38516
      - tipc
      - transport
      - patch

- block:
    - name: "MEDIUM | V-38518 | AUDIT | All rsyslog-generated log files must be owned by root."
      stat:
          path: "{{ item }}"
      with_items: "{{ rsyslog_logfiles.stdout_lines }}"
      register: rsyslog_logfiles_audit
      tags:
          - V-38518
          - V-38519

    - name: "MEDIUM | V-38518 | PATCH | All rsyslog-generated log files must be owned by root."
      file:
          path: "{{ item }}"
          owner: root
          follow: yes
          state: file
      with_items: "{{ rsyslog_logfiles.stdout_lines }}"
      register: result
      failed_when:
          - result | failed
          - not result.state == 'absent'
      tags:
          - V-38518

    - name: "MEDIUM | V-38519 | PATCH | All rsyslog-generated log files must be group-owned by root."
      file:
          dest: "{{ item }}"
          group: root
          state: file
          follow: yes
      with_items: "{{ rsyslog_logfiles.stdout_lines }}"
      register: result
      failed_when:
          - result | failed
          - not result.state == 'absent'
      tags:
          - V-38519
  tags:
      - cat2
      - medium
      - log_files
      - rsyslog
      - patch

# V-38520 not automatically remediated. See not_automated.yml
# - name: "MEDIUM | V-38520 | AUDIT | The operating system must back up audit records on an organization defined frequency onto a different system or media than the system being audited."

# V-38521 not automatically remediated. See not_automated.yml
# - name: "MEDIUM | V-38521 | AUDIT | The operating system must support the requirement to centrally manage the content of audit records generated by organization defined information system components."

- name: "MEDIUM | V-38523 | PATCH | The system must not accept IPv4 source-routed packets on any interface."
  sysctl:
      name: net.ipv4.conf.all.accept_source_route
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - V-38523
      - patch
      - ipv4
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38524 | PATCH | The system must not accept ICMPv4 redirect packets on any interface."
  sysctl:
      name: net.ipv4.conf.all.accept_redirects
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - V-38524
      - patch
      - ICMPv4
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38526 | PATCH | The system must not accept ICMPv4 secure redirect packets on any interface."
  sysctl:
      name: net.ipv4.conf.all.secure_redirects
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - V-38526
      - patch
      - ICMPv4
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38529 | PATCH | The system must not accept IPv4 source-routed packets by default."
  sysctl:
      name: net.ipv4.conf.default.accept_source_route
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - medium
      - cat2
      - V-38529
      - patch
      - ipv4
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38532 | PATCH | The system must not accept ICMPv4 secure redirect packets by default."
  sysctl:
      name: net.ipv4.conf.default.secure_redirects
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - medium
      - cat2
      - V-38532
      - patch
      - ICMPv4
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38539 | PATCH | The system must be configured to use TCP syncookies when experiencing a TCP SYN flood."
  sysctl:
      name: net.ipv4.tcp_syncookies
      value: 1
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - V-38539
      - patch
      - tcp
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38542 | PATCH | The system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces."
  sysctl:
      name: net.ipv4.conf.all.rp_filter
      value: 1
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - V-38542
      - patch
      - ipv4
      - sysctl
      - kernel_parameters
      - network
      - dhcp

- name: "MEDIUM | V-38544 | PATCH | The system must use a reverse-path filter for IPv4 network traffic when possible by default."
  sysctl:
      name: net.ipv4.conf.default.rp_filter
      value: 1
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - V-38544
      - patch
      - ipv4
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38548 | PATCH | The system must ignore ICMPv6 redirects by default."
  sysctl:
      name: net.ipv6.conf.default.accept_redirects
      value: 0
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  when: rhel6stig_ipv6_required
  tags:
      - medium
      - cat2
      - V-38548
      - patch
      - ICMPv4
      - sysctl
      - kernel_parameters
      - network

- name: |
         MEDIUM | V-38549 | PATCH | The system must employ a local IPv6 firewall.
         MEDIUM | V-38551 | PATCH | The operating system must connect to external networks or information systems only through managed IPv6 interfaces consisting of boundary protection devices arranged in accordance with an organizational security architecture.
         MEDIUM | V-38553 | PATCH | The operating system must prevent public IPv6 access into an organizations internal networks, except as appropriately mediated by managed interfaces employing boundary protection devices.
  service:
      name: ip6tables
      state: started
      enabled: yes
  when: rhel6stig_ipv6_required
  tags:
      - cat2
      - medium
      - ipv6
      - V-38549
      - V-38551
      - V-38553
      - firewall
      - network
      - patch

- name: "MEDIUM | V-38573 | PATCH | The system must disable accounts after three consecutive unsuccessful logon attempts."
  pamd:
      name: "{{ item }}"
      new_type: auth
      new_control: required
      new_module_path: pam_faillock.so
      module_arguments: preauth silent deny=3 unlock_time=604800 fail_interval=900
      state: before
      type: auth
      control: sufficient
      module_path: pam_unix.so
  with_items:
      - system-auth
      - password-auth
  tags:
      - cat2
      - medium
      - V-38573
      - logon_settings
      - accounts
      - patch
      - pam

- name: "MEDIUM | V-38573 | PATCH | The system must disable accounts after three consecutive unsuccessful logon attempts."
  pamd:
      name: "{{ item }}"
      new_type: auth
      new_control: '[default=die]'
      new_module_path: pam_faillock.so
      module_arguments: authfail deny=3 unlock_time=604800 fail_interval=900
      state: after
      type: auth
      control: sufficient
      module_path: pam_unix.so
  with_items:
      - system-auth
      - password-auth
  tags:
      - cat2
      - medium
      - V-38573
      - logon_settings
      - accounts
      - patch
      - pam

- name: "MEDIUM | V-38573 | PATCH | The system must disable accounts after three consecutive unsuccessful logon attempts."
  pamd:
      name: "{{ item }}"
      new_type: account
      new_control: required
      new_module_path: pam_faillock.so
      state: before
      type: account
      control: required
      module_path: pam_unix.so
  with_items:
      - system-auth
      - password-auth
  tags:
      - cat2
      - medium
      - V-38573
      - logon_settings
      - accounts
      - patch
      - pam

- block:
    - name: "MEDIUM | V-38574 | AUDIT | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (system-auth)."
      shell: find /etc/pam.d/ -type f -not -name '*.*'
      changed_when: no
      failed_when: no
      register: pamd_files
      check_mode: no

    - name: "MEDIUM | V-38574 | PATCH | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (system-auth)."
      # The PAM module doesn't make sense for this particular rule. Lineinfile works perfectly here.
      lineinfile:
          dest: "{{ item }}"
          backrefs: yes
          regexp: (^password\s*.*pam_unix.so.*)(md5|sha256|blowfish|bigcrypt)(.*)
          line: \1sha512\3
          backup: yes
      with_items: "{{ pamd_files.stdout_lines }}"
  tags:
      - cat2
      - medium
      - V-38574
      - logon_settings
      - accounts
      - passwords
      - patch

- name: "MEDIUM | V-38576 | PATCH | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (login.defs)"
  lineinfile:
      state: present
      backup: yes
      dest: /etc/login.defs
      regexp: '^ENCRYPT_METHOD'
      line: 'ENCRYPT_METHOD SHA512'
  tags:
      - cat2
      - medium
      - patch
      - V-38576
      - passwords

- name: "MEDIUM | V-38577 | PATCH | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (libuser.conf)"
  ini_file:
      state: present
      backup: yes
      dest: /etc/libuser.conf
      section: defaults
      option: crypt_style
      value: sha512
  tags:
      - cat2
      - medium
      - patch
      - V-38577
      - passwords

- name: "MEDIUM | V-38579 | PATCH | The system boot loader configuration file(s) must be owned by root."
  file:
      dest: /etc/grub.conf
      owner: root
      state: file
      follow: yes
  tags:
      - cat2
      - medium
      - V-38579
      - file_perms
      - grub
      - patch

- name: "MEDIUM | V-38580 | PATCH | The audit system must be configured to audit the loading and unloading of dynamic kernel modules."
  lineinfile:
      backup: yes
      line: '{{ item }}'
      dest: /etc/audit/audit.rules
      state: present
  with_items:
      - -w /sbin/insmod -p x -k modules
      - -w /sbin/rmmod -p x -k modules
      - -w /sbin/modprobe -p x -k modules
      - -a always,exit -F arch=b{{ ansible_architecture.split('_')[1] }} -S init_module -S delete_module -k modules
  tags:
    - cat2
    - medium
    - patch
    - kernel
    - auditd
    - V-38580

- name: "MEDIUM | V-38581 | PATCH | The system boot loader configuration file(s) must be group-owned by root"
  file:
      path: /etc/grub.conf
      group: root
      state: file
      follow: yes
  tags:
      - cat2
      - file_perms
      - medium
      - patch
      - V-38581
      - grub

# List all xinetd services then look for 'on' in the output
# If any xinted service is found to be on, skip these tasks since xinetd can be on if a service is using it
- block:
    - name: "MEDIUM | V-38582 | AUDIT | The xinetd service must be disabled if no network services utilizing it are enabled"
      command: chkconfig xinetd --list
      check_mode: no
      failed_when: no
      changed_when: no
      register: xinetd_service_check

    - name: "MEDIUM | V-38582 | PATCH | The xinetd service must be disabled if no network services utilizing it are enabled"
      service:
          name: xinetd
          enabled: no
          state: stopped
      when:
          - xinetd_service_check.rc == 0
          - not rhel6stig_xinetd_required
  tags:
      - cat2
      - medium
      - V-38582
      - xinetd
      - services
      - patch

- name: "MEDIUM | V-38583 | PATCH | The system boot loader configuration file(s) must have mode 0600 or less permissive."
  file:
      path: /etc/grub.conf
      state: file
      mode: u-x,go-rwx
      follow: yes
  tags:
      - cat2
      - V-38583
      - file_perms
      - medium
      - patch
      - grub

- block:
    - name: "MEDIUM | V-38585 | AUDIT | The system boot loader must require authentication."
      command: grep password /etc/grub.conf
      check_mode: no
      failed_when: no
      changed_when: no
      register: grub_auth_audit

    - name: "MEDIUM | V-38585 | PATCH | The system boot loader must require authentication."
      grub_crypt:
          password: "{{ rhel6stig_bootloader_password }}"
      register: grub_pass
      when: grub_auth_audit.rc == 1
      tags:
          - cat2
          - medium
          - V-38585
          - grub
          - passwords
          - patch

    - name: "MEDIUM | V-38585 | PATCH | The system boot loader must require authentication."
      lineinfile:
          state: present
          line: password --encrypted {{ grub_pass.passhash }}
          dest: /etc/grub.conf
          follow: yes
          insertafter: '^#\s'
          regexp: password
      when: grub_auth_audit.rc == 1
  tags:
      - cat2
      - medium
      - V-38585
      - grub
      - passwords
      - patch

- name: "MEDIUM | V-38586 | PATCH | The system must require authentication upon booting into single-user and maintenance modes."
  lineinfile:
      state: present
      backup: yes
      dest: /etc/sysconfig/init
      regexp: '^(#)?SINGLE'
      line: 'SINGLE=/sbin/sulogin'
  tags:
      - cat2
      - medium
      - V-38586
      - root_access
      - V-38503
      - patch

- name: "MEDIUM | V-38588 | PATCH | The system must not permit interactive boot."
  lineinfile:
      state: present
      backup: yes
      dest: /etc/sysconfig/init
      regexp: '^PROMPT='
      line: 'PROMPT=no'
  tags:
      - cat2
      - medium
      - V-38588
      - interactive_boot
      - patch

- name: "MEDIUM | V-38592 | PATCH | The system must require administrator action to unlock an account locked by excessive failed login attempts."
  pamd:
      name: "{{ item }}"
      new_type: auth
      new_control: required
      new_module_path: pam_faillock.so
      module_arguments: preauth silent deny=3 unlock_time=604800 fail_interval=900
      state: before
      type: auth
      control: sufficient
      module_path: pam_unix.so
  with_items:
      - system-auth
      - password-auth
  tags:
      - cat2
      - medium
      - V-38592
      - logon_settings
      - accounts
      - patch
      - pam

- name: "MEDIUM | V-38592 | PATCH | The system must require administrator action to unlock an account locked by excessive failed login attempts."
  pamd:
      name: "{{ item }}"
      new_type: auth
      new_control: '[default=die]'
      new_module_path: pam_faillock.so
      module_arguments: authfail deny=3 unlock_time=604800 fail_interval=900
      state: after
      type: auth
      control: sufficient
      module_path: pam_unix.so
  with_items:
      - system-auth
      - password-auth
  tags:
      - cat2
      - medium
      - V-38592
      - logon_settings
      - accounts
      - patch
      - pam

- name: "MEDIUM | V-38592 | PATCH | The system must require administrator action to unlock an account locked by excessive failed login attempts."
  pamd:
      name: "{{ item }}"
      new_type: account
      new_control: required
      new_module_path: pam_faillock.so
      state: before
      type: account
      control: required
      module_path: pam_unix.so
  with_items:
      - system-auth
      - password-auth
  tags:
      - cat2
      - medium
      - V-38592
      - logon_settings
      - accounts
      - patch
      - pam

- name: "MEDIUM | V-38593 | PATCH |  The Department of Defense (DoD) login banner must be displayed immediately prior to or as part of console login prompts"
  copy:
      content: "{{ rhel6stig_login_banner }}"
      dest: /etc/{{ item }}
      owner: root
      group: root
      mode: "0644"
      backup: yes
  with_items:
    - issue
    - issue.net
  tags:
      - cat2
      - medium
      - V-38593
      - logon_settings
      - dod_login_banner
      - patch

# Not automated
# - name: "MEDIUM | V-38595 | The system must be configured to require the use of a CAC, PIV compliant hardware token, or Alternate Logon Token (ALT) for authentication."

- name: "MEDIUM | V-38596 | PATCH | The system must implement virtual address space randomization."
  sysctl:
      name: kernel.randomize_va_space
      value: 2
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - patch
      - medium
      - sysctl
      - kernel
      - V-38596

- name: "MEDIUM | V-38597 | PATCH | The system must limit the ability of processes to have simultaneous write and execute access to memory."
  sysctl:
      name: kernel.exec-shield
      value: 1
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - cat2
      - patch
      - medium
      - sysctl
      - kernel
      - V-38597
      - kernel_parameters

- name: "MEDIUM | V-38599 | PATCH | The FTPS/FTP service on the system must be configured with the Department of Defense (DoD) login banner"
  lineinfile:
      state: present
      backup: yes
      dest: /etc/vsftpd/vsftpd.conf
      regexp: '^#?banner_file'
      line: 'banner_file=/etc/issue'
  failed_when: no
  notify: restart vsftpd
  tags:
      - cat2
      - medium
      - V-38599
      - vsftp
      - dod_login_banner
      - logon_settings
      - patch


- name: "MEDIUM | V-38600 | PATCH | The system must not send ICMPv4 redirects by default."
  sysctl:
      name: net.ipv4.conf.default.send_redirects
      value: 0
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - medium
      - cat2
      - V-38600
      - icmp
      - sysctl
      - patch

- name: "MEDIUM | V-38601 | PATCH | The system must not send ICMPv4 redirects from any interface."
  sysctl:
      name: net.ipv4.conf.all.send_redirects
      value: 0
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - medium
      - cat2
      - V-38601
      - icmp
      - sysctl
      - patch

- name: "MEDIUM | V-38603 | PATCH | The ypserv package must not be installed."
  yum:
      name: ypserv
      state: absent
  tags:
      - medium
      - V-38603
      - patch
      - cat2
      - ypserv
      - packages

- block:
    - name: "MEDIUM | V-38604 | AUDIT | The ypbind service must not be running."
      command: chkconfig ypbind --list
      changed_when: no
      failed_when: no
      check_mode: no
      register: ypbind_service_check

    - name: "MEDIUM | V-38604 | PATCH | The ypbind service must not be running."
      service:
          name: ypbind
          state: stopped
          enabled: no
      when: ypbind_service_check.rc == 0
  tags:
      - medium
      - V-38604
      - patch
      - cat2
      - ypbind
      - services

- block:
    - name: "MEDIUM | V-38605 | AUDIT | Make sure the cron package is installed"
      yum:
          name: "{{item}}"
          state: present
      with_items:
          - cronie
          - cronie-anacron

    - name: "MEDIUM | V-38605 | PATCH | The cron service must be running"
      service:
          name: crond
          state: started
          enabled: yes
  tags:
      - medium
      - cat2
      - cron
      - patch
      - V-38605
      - services

- name: "MEDIUM | V-38606 | PATCH | The tftp-server packages must not be intalled unless required."
  yum:
      name: tftp-server
      state: absent
  when: not rhel6stig_tftp_required
  tags:
      - medium
      - cat2
      - V-38606
      - tftp
      - packages
      - patch

# Use command instead of service since the service module fails when trying
# to manage xined services
- block:
    - name: "MEDIUM | V-38609 | AUDIT | The tftp service must not be running unless required."
      command: chkconfig tftp --list
      changed_when: no
      check_mode: no
      failed_when: no
      register: tftp_service_check

    - name: "MEDIUM | V-38609 | PATCH | The TFTP service must not be running."
      command: chkconfig tftp off
      when:
          - not rhel6stig_tftp_required
          - "tftp_service_check.rc == 0"
          - "'on' in tftp_service_check.stdout"
  tags:
      - medium
      - cat2
      - V-38609
      - tftp
      - services
      - patch

- name: "MEDIUM | V-38611 | PATCH | The SSH daemon must ignore .rhosts files."
  lineinfile:
      state: present
      regexp: '^#?IgnoreRhosts'
      line: IgnoreRhosts yes
      dest: /etc/ssh/sshd_config
      validate: sshd -t -f %s
  notify: restart sshd
  tags:
      - cat2
      - medium
      - patch
      - V-38611
      - rhosts
      - sshd

- name: "MEDIUM | V-38612 | PATCH | The SSH daemon must not allow host-based authentication."
  lineinfile:
      state: present
      regexp: '^#?HostbasedAuthentication'
      line: HostbasedAuthentication no
      dest: /etc/ssh/sshd_config
      validate: sshd -t -f %s
  notify: restart sshd
  tags:
      - cat2
      - medium
      - patch
      - V-38612
      - sshd


- name: "MEDIUM | V-38613 | PATCH | The system must not permit root logins using remote access programs such as ssh."
  lineinfile:
      state: present
      dest: /etc/ssh/sshd_config
      regexp: '^#?PermitRootLogin'
      line: 'PermitRootLogin no'
      validate: sshd -t -f %s
  notify: restart sshd
  tags:
      - cat2
      - medium
      - patch
      - V-38613
      - sshd

- name: "MEDIUM | V-38615 | PATCH | The SSH daemon must be configured with the Department of Defense (DoD) login banner."
  lineinfile:
    state: present
    dest: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: Banner /etc/issue
    validate: sshd -t -f %s
  notify: restart sshd
  tags:
      - cat2
      - medium
      - V-38615
      - sshd
      - logon_settings
      - dod_login_banner

- name: "MEDIUM | V-38617 | PATCH | The SSH daemon must be configured to use only FIPS 140-2 approved ciphers."
  lineinfile:
      state: present
      dest: /etc/ssh/sshd_config
      regexp: '^#?Ciphers'
      line: Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-cbc,3des-cbc,aes192-cbc,aes256-cbc
      validate: sshd -t -f %s
  notify: restart sshd
  tags:
      - cat2
      - medium
      - patch
      - V-38617
      - sshd

- name: "MEDIUM | V-38619 | PATCH | There must be no .netrc files on the system"
  file:
      state: absent
      dest: "~{{ item }}/.netrc"
  with_items: "{{ users.stdout_lines }}"
  tags:
      - cat2
      - medium
      - patch
      - V-38619
      - netrc

- block:
    - name: MEDIUM | V-38620, V-38621 | Ensure NTP is installed
      yum:
          name: ntp
          state: present
      tags:
          - V-38620
          - V-38621

    - name: "MEDIUM | V-38620 | PATCH | The system clock must be synchronized continuously or at least daily."
      service:
          name: ntpd
          state: started
          enabled: yes
      tags:
          - V-38620

    - name: "MEDIUM | V-38621 | PATCH | The system clock must be synchronized to an authoritative DoD time source."
      template:
          src: ntp.conf.j2
          dest: /etc/ntp.conf
          owner: root
          group: root
          mode: 0644
      notify: restart ntpd
      tags:
          - V-38621
  tags:
      - cat2
      - medium
      - patch
      - ntp

- name: "MEDIUM | V-38622 | PATCH | Mail relaying must be restricted."
  lineinfile:
      state: present
      backup: yes
      dest: /etc/postfix/main.cf
      regexp: '^inet_interfaces'
      line: 'inet_interfaces = localhost'
      insertafter: '^#(\s)+?inet_interfaces'
  when: not rhel6stig_is_mail_relay
  notify: restart postfix
  tags:
      - cat2
      - medium
      - patch
      - V-38622
      - postfix

- block:
    - name: "MEDIUM | V-38623 | PATCH | All rsyslog-generated log files must have mode 0600 or less permissive."
      file:
          dest: "{{ item }}"
          mode: 0600
          state: file
      with_items: "{{ rsyslog_logfiles.stdout_lines }}"
      register: result
      failed_when:
          - result | failed
          - not result.state == 'absent'

    # As described in https://access.redhat.com/solutions/66805, the
    # permissions for /var/log/boot.log have to be changed each time the
    # system is rebooted.
    - name: "MEDIUM | V-38623 | PATCH | All rsyslog-generated log files must have mode 0600 or less permissive."
      lineinfile:
          dest: /etc/rc.d/rc.local
          line: chmod u-x,go-rwx /var/log/boot.log
      register: result
      failed_when:
          - result | failed
          - not result.state == 'absent'
  tags:
      - cat2
      - medium
      - V-38623
      - file_perms
      - rsyslog
      - patch

- block:
    - name: MEDIUM | V-38628, V-38631, V-38632 | Ensure audit package is installed
      yum:
          name: audit
          state: present
      tags:
          - V-38628
          - V-38631
          - V-38632

    - name: |

            MEDIUM | V-38628 | PATCH | The operating system must produce audit records containing sufficient information to establish the identity of any user/subject associated with the event
            MEDIUM | V-38631 | PATCH | The operating system must employ automated mechanisms to facilitate the monitoring and control of remote access methods
            MEDIUM | V-38632 | PATCH | The operating system must produce audit records containing sufficient information to establish what type of events occurred.
      service:
          name: auditd
          state: started
          enabled: yes
  tags:
      - cat2
      - medium
      - patch
      - V-38628
      - V-38631
      - V-38632
      - auditd

- block:
    - name: MEDIUM | V-38629 | AUDIT | The graphical desktop environment must set the idle timeout to no more than 15 minutes
      command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --get /apps/gnome-screensaver/idle_delay
      changed_when: idle_timeout_gconf_audit.stdout != "15" or idle_timeout_gconf_audit.stderr != ""
      check_mode: no
      register: idle_timeout_gconf_audit

    - name: MEDIUM | V-38629 | PATCH | The graphical desktop environment must set the idle timeout to no more than 15 minutes
      command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type int --set /apps/gnome-screensaver/idle_delay 15
      when: idle_timeout_gconf_audit.changed
  when: rhel6stig_xwindows_required
  tags:
      - cat2
      - medium
      - patch
      - V-38629
      - gui
      - screen_lock

- block:
    - name: "MEDIUM | V-38630 | AUDIT | The graphical desktop environment must automatically lock after 15 minutes of inactivity and the system must require user to re-authenticate to unlock the environment"
      command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --get /apps/gnome-screensaver/idle_activation_enabled
      changed_when: idle_lock_audit.stdout != "true" or idle_lock_audit.stderr != ""
      check_mode: no
      register: idle_lock_audit

    - name: "MEDIUM | V-38630 | PATCH | The graphical desktop environment must automatically lock after 15 minutes of inactivity and the system must require user to re-authenticate to unlock the environment"
      command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gnome-screensaver/idle_activation_enabled true
      when: idle_lock_audit.changed
  when: rhel6stig_xwindows_required
  tags:
      - cat2
      - medium
      - patch
      - V-38630
      - gui
      - screen_lock

- name: "MEDIUM | V-38633 | PATCH | The system must set a maximum audit log file size."
  lineinfile:
      state: present
      backup: yes
      dest: /etc/audit/auditd.conf
      regexp: '^#?max_log_file\b'
      line: max_log_file = {{ rhel6stig_auditd_config["max_log_file"] }}
  notify: restart auditd
  tags:
      - cat2
      - medium
      - patch
      - V-38633
      - auditd

- name: "MEDIUM | V-38634 | PATCH | The system must rotate audit log files that reach the maximum file size."
  lineinfile:
      state: present
      backup: yes
      dest: /etc/audit/auditd.conf
      regexp: '^#?max_log_file_action\b'
      line: max_log_file_action = {{ rhel6stig_auditd_config["max_log_file_action"] }}
  notify: restart auditd
  tags:
      - cat2
      - medium
      - patch
      - V-38634
      - auditd

- name: "MEDIUM | V-38636 | PATCH | The system must retain enough rotated audit logs to cover the required log retention period."
  lineinfile:
      state: present
      backup: yes
      dest: /etc/audit/auditd.conf
      regexp: '^#?num_logs'
      line: num_logs = {{ rhel6stig_auditd_config["num_logs"] }}
  notify: restart auditd
  tags:
      - cat2
      - medium
      - patch
      - V-38636
      - auditd

- block:
    - name: "MEDIUM | V-38637 | AUDIT | The system package management tool must verify contents of all files associated with the audit package."
      shell: "rpm -V audit | awk '$1 ~ /..5/ && $2 != \"c\"'"
      args:
          warn: no
      changed_when: no
      failed_when: audit_package_integrity_check_audit.stderr
      register: audit_package_integrity_check_audit
      check_mode: no

    - name: "MEDIUM | V-38637 | PATCH | The system package management tool must verify contents of all files associated with the audit package."
      command: yum -y reinstall audit
      args:
          warn: no
      when: audit_package_integrity_check_audit.stdout
  tags:
      - cat2
      - medium
      - patch
      - V-38637
      - auditd
      - rpm

- block:
    - name: "MEDIUM | V-38638 | AUDIT | The graphical desktop environment must have automatic lock enabled"
      command: >
          gconftool-2 --direct
                    --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory
                    --get /apps/gnome-screensaver/lock_enabled
      check_mode: no
      changed_when: auto_lock_enable_audit.stdout != "true" or auto_lock_enable_audit.stderr != ""
      register: auto_lock_enable_audit

    - name: "MEDIUM | V-38638 | PATCH | The graphical desktop environment must have automatic lock enabled"
      command: >
          gconftool-2 --direct
                    --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory
                    --type bool
                    --set /apps/gnome-screensaver/lock_enabled true
      when: auto_lock_enable_audit.changed
  when: rhel6stig_xwindows_required
  tags:
      - cat2
      - medium
      - patch
      - V-38638
      - gui
      - screen_lock

# Not automated
# - name: "MEDIUM | V-38643 | AUDIT | There must be no world-writable files on the system."
# - name: "MEDIUM | V-38652 | AUDIT | Remote file systems must be mounted with the 'nodev' option"
# - name: "MEDIUM | V-38654 | AUDIT | Remote file systems must be mounted with the nosuid option"

- name: "MEDIUM | V-38658 | PATCH | The system must prohibit the reuse of passwords within five iterations."
  pamd:
      name: system-auth
      new_type: password
      new_control: requisite
      new_module_path: pam_pwhistory.so
      module_arguments: use_authtok remember={{ rhel6stig_pass_reuse }}
      state: after
      type: password
      control: requisite
      module_path: pam_cracklib.so
  tags:
      - cat2
      - medium
      - patch
      - V-38658
      - pam

- block:
    - name: "MEDIUM | V-38660 | AUDIT | The snmpd service must use only SNMP protocol version 3 or newer."
      shell: grep 'v1\|v2c\|com2sec' /etc/snmp/snmpd.conf | grep -v '^#'
      changed_when: no
      failed_when: no
      register: snmpd_version_audit
      check_mode: no

    - name: "MEDIUM | V-38660 | PATCH | The snmpd service must use only SNMP protocol version 3 or newer."
      lineinfile:
          dest: /etc/snmp/snmpd.conf
          state: absent
          regexp: '^.*(v1|v2c|com2sec).*'
      when: snmpd_version_audit.rc == 0
      notify: restart snmpd
  tags:
      - cat2
      - medium
      - patch
      - V-38660
      - snmp

- block:
    - name: "MEDIUM | V-38663 | AUDIT | The system package management tool must verify permissions on all files and directories associated with the audit package."
      shell: rpm -V audit | grep '^.M'
      args:
          warn: no
      register: audit_package_permissions_audit
      failed_when: no
      changed_when: no
      check_mode: no

    - name: "MEDIUM | V-38663 | PATCH | The system package management tool must verify permissions on all files and directories associated with the audit package."
      command: rpm --setperms audit
      when: audit_package_permissions_audit.stdout
  tags:
      - cat2
      - medium
      - patch
      - V-38663
      - file_perms
      - auditd
      - rpm

- block:
    - name: "MEDIUM | V-38664 | AUDIT | The system package management tool must verify ownership on all files and directories associated with the audit package."
      shell: rpm -V audit | grep '^.....U'
      args:
          warn: no
      failed_when: no
      changed_when: no
      register: audit_package_ownership_audit
      check_mode: no

    - name: "MEDIUM | V-38664 | PATCH | The system package management tool must verify ownership on all files and directories associated with the audit package."
      command: rpm --setugids audit
      when: audit_package_ownership_audit.stdout
  tags:
      - cat2
      - medium
      - patch
      - V-38664
      - auditd
      - file_perms
      - rpm

- block:
    - name: "MEDIUM | V-38665 | AUDIT | The system package management tool must verify group-ownership on all files and directories associated with the audit package."
      shell: rpm -V audit | grep '^......G'
      failed_when: no
      changed_when: no
      register: audit_package_group_ownership_audit
      check_mode: no

    - name: "MEDIUM | V-38665 | PATCH | The system package management tool must verify group-ownership on all files and directories associated with the audit package."
      command: rpm --setugids audit
      when: audit_package_group_ownership_audit.stdout
  tags:
      - cat2
      - medium
      - patch
      - V-38665
      - auditd
      - file_perms
      - rpm

- block:
    - name: MEDIUM | V-38666 | PATCH | The system must use and update a virus scan program"
      yum:
          name: "{{ rhel6stig_av_package.package }}"
          state: present

    - name: MEDIUM | V-38666 | PATCH | The system must use and update a virus scan program"
      service:
          name: "{{ rhel6stig_av_package.service }}"
          state: started
          enabled: yes
  when:
      - rhel6stig_antivirus_required
  tags:
      - cat2
      - medium
      - patch
      - V-38666
      - antivirus

# Not automated
# - name: "MEDIUM |  V-38667 | Inspect the system to determine if intrusion detection software has been installed."

- name: |

        MEDIUM | V-38670 | PATCH | The operating system must detect unauthorized changes to software and information.
        MEDIUM | V-38673 | PATCH | The operating system must ensure unauthorized, security-relevant configuration changes detected are tracked.
        MEDIUM | V-38695 | PATCH | A file integrity tool must be used at least weekly to check for unauthorized file changes, particularly the addition of unauthorized system libraries or binaries, or for unauthorized modification to authorized system libraries or binaries.
        MEDIUM | V-38696 | PATCH | The operating system must employ automated mechanisms, per organization defined frequency, to detect the addition of unauthorized components/devices into the operating system.
        MEDIUM | V-38698 | PATCH | The operating system must employ automated mechanisms to detect the presence of unauthorized software on organizational information systems and notify designated organizational officials in accordance with the organization defined frequency.
        MEDIUM | V-38700 | PATCH | The operating system must provide a near real-time alert when any of the organization defined list of compromise or potential compromise indicators occurs.
  cron:
      name: Run AIDE integrity check weekly
      cron_file: "{{ rhel6stig_aide_cron['cron_file'] }}"
      user: "{{ rhel6stig_aide_cron['cron_user'] }}"
      minute: "{{ rhel6stig_aide_cron['aide_minute'] | default('05') }}"
      hour: "{{ rhel6stig_aide_cron['aide_hour'] | default('04') }}"
      day: "{{ rhel6stig_aide_cron['aide_day'] | default('*') }}"
      month: "{{ rhel6stig_aide_cron['aide_month'] | default('*') }}"
      weekday: "{{ rhel6stig_aide_cron['aide_weekday'] | default('*') }}"
      job: "{{ rhel6stig_aide_cron['aide_job'] }}"
  tags:
      - cat2
      - medium
      - patch
      - V-38670
      - V-38673
      - V-38695
      - V-38696
      - V-38698
      - V-38700
      - file_integrity
      - aide

- block:
    - name: "MEDIUM | V-38671 | PATCH | Postfix must be installed before removing sendmail."
      yum:
          name: postfix
          state: present

    - name: "MEDIUM | V-38671 | PATCH | The sendmail package must be removed"
      yum:
          name: sendmail
          state: absent
  tags:
      - cat2
      - medium
      - patch
      - V-38671
      - sendmail
      - unauthorized_packages

- name: "MEDIUM | V-38674 | PATCH | X Windows must not be enabled unless required"
  lineinfile:
      state: present
      dest: /etc/inittab
      regexp: '^id:'
      line: 'id:3:initdefault:'
      backup: yes
  when: not rhel6stig_xwindows_required
  tags:
      - cat2
      - medium
      - patch
      - V-38674
      - xwindows
      - gui

- name: "MEDIUM | V-38678 | PATCH | The audit system must provide a warning when allocated audit record storage volume reaches a documented percentage of maximum audit record storage capacity."
  lineinfile:
      regexp: ^{{ item }}\s*=.*
      line: "{{ item }} = {{ rhel6stig_auditd_config[item] }}"
      dest: /etc/audit/auditd.conf
  with_items:
      - admin_space_left
      - space_left
  tags:
      - cat2
      - medium
      - V-38678
      - patch
      - auditd

- name: "MEDIUM | V-38679 | PATCH | The DHCP client must be disabled if not needed"
  lineinfile:
      state: present
      dest: "{{ item.path }}"
      regexp: ^BOOTPROTO=
      line: 'BOOTPROTO="none"'
  with_items: "{{ interface_config_files.files }}"
  when:
      - interface_config_files.matched > 0
      - not rhel6stig_use_dhcp
  tags:
      - cat2
      - medium
      - V-38679
      - network
      - dhcp
      - patch

- name: "MEDIUM | V-38680 | PATCH | The audit system must identify staff members to receive notifications of audit log storage volume capacity issues."
  lineinfile:
    regexp: '^action_mail_acct = .*'
    line: 'action_mail_acct = root'
    state: present
    dest: /etc/audit/auditd.conf
  tags:
      - cat2
      - medium
      - V-38680
      - auditd
      - patch

- name: "MEDIUM | V-38682 | PATCH | The Bluetooth kernel module must be disabled."
  copy:
      content: |
          install net-pf-31 /bin/true
          install bluetooth /bin/true
      dest: /etc/modprobe.d/disable-bluetooth.conf
      owner: root
      group: root
      mode: 0644
  tags:
      - cat2
      - medium
      - V-38682
      - bluetooth
      - kernel_modules
      - patch

- block:
    - name: "MEDIUM | V-38686 | AUDIT | iptables module is not idempotent for Policy actions currently"
      shell: iptables -S | grep '\-P FORWARD' | cut -d ' ' -f 3
      changed_when: no
      failed_when: no
      check_mode: no
      register: iptables_forward_chain_policy_check

    - name: "MEDIUM | V-38686 | PATCH | The systems local firewall must implement a deny-all, allow-by-exception policy for forwarded packets."
      iptables:
          chain: FORWARD
          ip_version: ipv4
          policy: DROP
      when: "iptables_forward_chain_policy_check.stdout != 'DROP'"
      notify: save iptables rules
  tags:
      - cat2
      - medium
      - V-38686
      - ipv4
      - firewall
      - network
      - patch

- name: "MEDIUM | V-38688 | PATCH | A login banner must be displayed immediately prior to, or as part of, graphical desktop environment login prompts."
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gdm/simple-greeter/banner_message_enable true"
  when: rhel6stig_xwindows_required
  notify: restart gdm
  tags:
      - cat2
      - V-38688
      - logon_settings
      - xwindows
      - gui
      - dod_login_banner
      - patch

- name: "MEDIUM | V-38689 | PATCH | The Department of Defense (DoD) login banner must be displayed immediately prior to, or as part of, graphical desktop environment login prompts"
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type string --set /apps/gdm/simple-greeter/banner_message_text '  {{ rhel6stig_graphical_login_banner }}'"
  when: rhel6stig_xwindows_required
  notify: restart gdm
  tags:
      - cat2
      - V-38689
      - logon_settings
      - xwindows
      - gui
      - dod_login_banner
      - patch

- block:
    - name: "MEDIUM | V-38691 | AUDIT | The Bluetooth service must be disabled"
      command: chkconfig bluetooth --list
      check_mode: no
      failed_when: no
      changed_when: no
      register: bluetooth_service_check

    - name: "MEDIUM | V-38691 | PATCH | The Bluetooth service must be disabled"
      service:
          name: bluetooth
          state: stopped
          enabled: no
      when: bluetooth_service_check.rc == 0
  tags:
      - cat2
      - medium
      - V-38691
      - bluetooth
      - services
      - patch

- name: "MEDIUM | V-43150 | PATCH | The login user list must be disabled."
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gdm/simple-greeter/disable_user_list true"
  when: rhel6stig_xwindows_required
  notify: restart gdm
  tags:
      - cat2
      - V-43150
      - logon_settings
      - xwindows
      - gui
      - SCIF_logon_banner
      - patch

- name: "MEDIUM | V-51337 | PATCH | The system must use a Linux Security Module at boot time."
  lineinfile:
      dest: /etc/grub.conf
      regexp: '^(\s+kernel\s/boot/.*?)(?:\sselinux=0)(.*?)$'
      line: '\1\2'
      backrefs: yes
      follow: yes
  tags:
      - cat2
      - medium
      - V-51337
      - selinux
      - patch

- name: "MEDIUM | V-51363 | PATCH | The system must use a Linux Security Module configured to enforce limits on system services."
  selinux:
      conf: /etc/selinux/config
      policy: "{{ rhel6stig_selinux_pol }}"
      state: enforcing
  tags:
      - cat2
      - medium
      - V-51363
      - selinux
      - patch

- name: "MEDIUM | V-51391 | AUDIT | A file integrity baseline must be created."
  stat:
      path: "{{rhel6stig_aide_dbdir}}/{{rhel6stig_aide_dbfile}}"
  register: aide_dbfile
  changed_when: not aide_dbfile.stat.exists
  notify: init aide
  tags:
      - cat2
      - medium
      - V-51391
      - aide
      - patch

- name: "MEDIUM | V-51875 | PATCH  | The operating system, upon successful logon/access, must display to the user the number of unsuccessful logon/access attempts since the last successful logon/access."
  pamd:
      name: system-auth
      new_type: session
      new_control: required
      new_module_path: pam_lastlog.so
      module_arguments: showfailed
      state: after
      type: session
      control: required
      module_path: pam_limits.so
  tags:
      - cat2
      - medium
      - V-51875
      - pam
      - patch
      - pam

- name: "MEDIUM | V-54381 | PATCH | The audit system must switch the system to single-user mode when available audit storage volume becomes dangerously low."
  lineinfile:
      regexp: '^admin_space_left_action'
      line: "admin_space_left_action = {{ rhel6stig_auditd_config['admin_space_left_action'] }}"
      dest: /etc/audit/auditd.conf
  tags:
      - cat2
      - medium
      - V-54381
      - auditd
      - patch

- block:
    - name: "MEDIUM | V-57569 | AUDIT | The noexec option must be added to the /tmp partition."
      command: egrep '^([^#[:space:]]+[[:space:]]+/tmp[[:space:]]+[^[:space:]]+[[:space:]]+)([^[:space:]]+)([[:space:]]+.*)$' /etc/fstab
      changed_when: no
      failed_when: no
      check_mode: no
      register: fstab_tmp_audit

    - name: "MEDIUM | V-57569 | PATCH | The noexec option must be added to the /tmp partition."
      lineinfile:
          regexp: '^([^\s]+\s+/tmp\s+[^\s]+\s+)([^\s]+)(\s+.*)$'
          line: '\1\2,noexec\3'
          backrefs: yes
          dest: /etc/fstab
          backup: yes
      when: "'/tmp' in fstab_mountpoints.stdout_lines and 'noexec' not in fstab_tmp_audit.stdout"
      notify: remount /tmp
  tags:
      - cat2
      - medium
      - V-57569
      - fstab
      - tmpdir
      - patch

- block:
    - name: "MEDIUM | V-58901 | AUDIT | The sudo command must require authentication."
      # find included configs
      shell: cat /etc/sudoers | grep -w '^#include' | awk '{print $2}'
      check_mode: no
      changed_when: no
      register: sudoers_include_audit

    - name: "MEDIUM | V-58901 | AUDIT | The sudo command must require authentication."
      # Find files found in the dirs of  #includedir directives
      shell: cat /etc/sudoers | grep -w '^#includedir' | awk '{print $2}' | xargs -i find {} -type f
      check_mode: no
      changed_when: no
      register: sudoers_includedirs_files

    - name: "MEDIUM | V-58901 | AUDIT | The sudo command must require authentication."
      # Combine lists
      set_fact:
          sudoer_configs: "{{ sudoers_include_audit.stdout_lines + sudoers_includedirs_files.stdout_lines + ['/etc/sudoers'] }}"

    - name: "MEDIUM | V-58901 | PATCH | The sudo command must require authentication."
      lineinfile:
          dest: "{{ item }}"
          line: \1\2
          regexp: (.*)(!authenticate|NOPASSWD)(.*)
          state: absent
      with_items: "{{ sudoer_configs }}"
  when: not rhel6stig_allow_sudo_without_password
  tags:
      - cat2
      - medium
      - V-58901
      - sudoers
      - patch

- block:
    - name: "MEDIUM | V-72817 | AUDIT | Wireless network adapters must be disabled."
      find:
          paths: /etc/sysconfig/network-scripts
          file_type: file
          patterns: ifcfg-wlan*
      check_mode: no
      register: wireless_interface_config_files

    - name: "MEDIUM | V-72817 | PATCH | Wireless network adapters must be disabled."
      file:
          path: "{{item}}"
          state: absent
          backup: yes
      with_items: "{{ wireless_interface_config_files.files }}"
      when:
          - wireless_interface_config_files.matched > 0
          - not rhel6stig_wireless_required
  tags:
      - cat2
      - medium
      - V-72817
      - wireless
      - patch
